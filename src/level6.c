#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

char DATA[] = "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BAAAAAAAAAAAAAAAAAAAADUAAAABAAAAAgAAAAAAAACwBkAAAAAAALAGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAABEAAAAAQAAAAIAAAAAAAAAsAZAAAAAAACwBgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAUAAAAAEAAAACAAAAAAAAALAGQAAAAAAAsAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAJIAAAABAAAABgAAAAAAAACwBkAAAAAAALAGAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAABAAAAAAAAACXAAAA////bwIAAAAAAAAAAAdAAAAAAAAABwAAAAAAABIAAAAAAAAAAgAAAAAAAAACAAAAAAAAAAIAAAAAAAAApAAAAP7//28CAAAAAAAAABgHQAAAAAAAGAcAAAAAAAAwAAAAAAAAAAMAAAABAAAACAAAAAAAAAAAAAAAAAAAAAcAAAABAAAAAwAAAAAAAABIB2AAAAAAAEgHAAAAAAAADQIAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAB6AAAABgAAAAMAAAAAAAAAWAlgAAAAAABYCQAAAAAAAPAAAAAAAAAAAwAAAAAAAAAIAAAAAAAAABAAAAAAAAAAgwAAAAEAAAADAAAAAAAAAEgKYAAAAAAASAoAAAAAAABYAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAEAAAAAAAAAA0AAAAIAAAAAwAAAAAAAACgCmAAAAAAAKAKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAACzAAAAAwAAAAAAAAAAAAAAAAAAAAAAAACgCgAAAAAAAL0AAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAA";

char TMP[] = "\x05^GZ\x05rrrrrr";
char DECODE_STR[] = "\nV\nHKYO\x1c\x1e\n\x07N\n\x14\n";
char CHMOD_STR[] = "\x11\nIBGEN\n\x01R\n";
char REMOVE_STR[] = "XG\n";

void create_temp() {
	memfrob(TMP, strlen(TMP));
	mktemp(TMP);
	memfrob(TMP, strlen(TMP));
}

void dump() {
	FILE * tmpfile = NULL;
	char cmd[8192] = "OIBE\n";
	memfrob(cmd, strlen(cmd));
	memfrob(DECODE_STR, strlen(DECODE_STR));
	memfrob(CHMOD_STR, strlen(CHMOD_STR));
	memfrob(TMP, strlen(TMP));
	strcat(cmd, DATA);
	strcat(cmd, DECODE_STR);
	strcat(cmd, TMP);
	strcat(cmd, CHMOD_STR);
	strcat(cmd, TMP);
	system(cmd);
	memfrob(cmd, strlen(cmd));
	memfrob(DECODE_STR, strlen(DECODE_STR));
	memfrob(CHMOD_STR, strlen(CHMOD_STR));
	memfrob(TMP, strlen(TMP));
}

void execute_payload(const char * param_1, const char * param_2) {
	memfrob(TMP, strlen(TMP));
	memfrob(REMOVE_STR, strlen(REMOVE_STR));
	const char * argv[] = {TMP, param_1, param_2, NULL};
	char cmd[256] = {};
	for (int i = 0; argv[i]; i++) {
		strcat(cmd, argv[i]);
		strcat(cmd, " ");
	}
	system(cmd);
	strcpy(cmd, REMOVE_STR);
	strcat(cmd, TMP);
	system(cmd);
	memfrob(TMP, strlen(TMP));
	memfrob(REMOVE_STR, strlen(REMOVE_STR));
}

void copy_param(int count, char * buffer, char * src) {
	if (count > 1) {
		strncpy(buffer, src, 255);
	}
}

int main(int argc, char * argv[]) {
	setreuid(geteuid(), geteuid());
	char buffer[256] = {};
	copy_param(argc, buffer, argv[1]);
	create_temp();
	dump();
	char param_1[256] = {}, param_2[256] = {};
	strncpy(param_1, buffer, strlen(buffer) / 2);
	strcat(param_2, buffer + strlen(buffer) - 1);
	execute_payload(param_1, param_2);
	return 0;
}
